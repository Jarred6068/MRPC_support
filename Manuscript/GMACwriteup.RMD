---
title: "A Comparison of GMAC and ADDIS"
author: 
-  Jarred Kvamme, University of Idaho
date: "9/22/2021"
output: pdf_document
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(latex2exp)
library(gridExtra)
```

\section*{1. Overview}
Both MRPC-LOND and MRPC-ADDIS techniques inferred a large number of trans mediated trios. The trans-mediation model has been previously identified, but is not the commonly ackowledged mode of mediation. Since this result is surprising relative to the existing literature, we sought to apply another method for inferring mediation on a subset of GTEx trios analyzed herein by MRPC. The Genomic Mediation analysis with Adaptive Confounding (GMAC) algorithm allows for a unique selection of a subset of potential confounders, ${\bf X_{ij}}$ from a larger covariate pool, ${\bf H}$, for each trio. By taking advantage of the Principle of Mendelian Randomization, the authors filter ${\bf H}$ by removing common child and intermediate confounding variables (e.g variables associated with the eQTL as well as the cis/trans genes). Post-filtering, GMAC preforms a mediation test on the edge between the cis gene and trans gene via the regression of the trans-gene $T_j$ on the cis-eQTL $L_i$, cis-gene $C_i$, and the set of adaptively selected confounders ${\bf X_{ij}}$:

\begin{eqnarray} T_j = \beta_0 + \beta_1 C_i + \beta_2 L_i + {\bf \Gamma} {\bf X}_{ij} + \epsilon \end{eqnarray}

The mediation statistic is the observed $t$-value of the cis-gene coefficient $\beta_1$. A null distribution for no-mediation is constructed by iteratively permuting the values of the cis-transcript within each genotype and repeating the above regression. The authors argue that the permutation of the cis-transcript within the genotypes of the cis-eQTL removes the association between the cis and trans gene transcripts while preserving the higher order associations with the cis-eQTL. The resulting mediation test compares the observed relationship between the trans and cis gene to a null distribution constructed from a model with no association and assuming that possible confounding has been well adjusted via the selected covariates. 

It is important to note that the above mediation test describes only the association between cis-gene and trans-gene transcripts ($C_i \leftrightarrow T_j$ ) and does not consider possible effects between the cis-eQTL and the cis-gene transcript ($L_i \rightarrow C_i$), or the cis-eQTL and trans-gene transcript ($L_i \rightarrow T_j$).

\section*{2. Methods}
\subsection*{2.1 Applying GMAC to GTEx Trios}

To compare the GMAC and MRPC algorithms, we applied the GMAC algorithm to the top five GTEx tissues by sample size. Following with the creators of GMAC, we used the full set of principle components retained from the PCA of the expression matrix as the covariate pool, and three additional known confounders: the PCR used, the platform used, and sex of the individual in each sample [@yang2017identifying].    

Consistent with @yang2017identifying, the analysis was preformed using a common child and intermediate variable filtering  FDR of $10\%$ and a confounder selection FDR of $5\%$ for each trio. Each trio supplied to GMAC consisted of the cis-QTL and the PEER normalized cis and trans gene transcripts with the highest association to the eQTL. To mitigate missing values in the eQTL matrix, multiple imputation of the matrix of unique cis-eQTLs was preformed via multiple correspondence analysis (MCA) prior to its use in GMAC [@josse2016missmda]. The analysis was preformed twice on each trio, first with the cis gene as the mediator and second with the trans gene as the mediator. This allowed for GMAC inferred trios to be decomposed into the three groupings used under MRPC: 1) Cis-gene mediation, 2) Trans-gene mediation, 3) both (undirected). 

\subsection*{2.2 Comparison of GMAC and MRPC Results}
   
After applying GMAC to each tissue, the false discovery rate among the retained mediation p-values was controlled at the more liberal rate of $10\%$ [@yang2017identifying]. Each trio determined to have significant mediation after FDR filtering was compared with the regulatory network type inferred by MRPC-ADDIS. MRPC-ADDIS can infer three types of regulatory networks that contain an edge between the cis and trans gene (M1, M2, or M4). Since GMAC considers only the presence of the edge and not its direction, trios inferred to be one of M1, M2, or M4 under ADDIS, that were also significant under GMAC, were considered consistent (e.g $C_i \rightarrow T_j$; $T_j \rightarrow C_i$; $C_i \leftrightarrow T_j$ are synonymous under GMAC).   

\subsection*{2.3 Simulations}
To further understand the conflicting behavior between MRPC-ADDIS and GMAC, we simulated the mediation test - the test for the $\beta_1$ coefficient in the presence of all adaptively selected confounders, ${\bf X}_{ij}$, as described by the regression in \textbf{eq (1)}. We simulated the trans gene of each trio using the linear relationship:

\begin{eqnarray} T^{\ast}_{j} = \hat{\beta_0}+\hat{\beta_1}C_i + \hat{\beta_2}L_i + \hat{{\bf\Gamma}} {\bf W}_{ij} +\epsilon  \end{eqnarray}

where $T^{\ast}_{j}$ is the simulated trans gene, the coefficients are replaced by their estimates from the regression in \textbf{eq (1)}, and ${\bf W}_{ij}$ is a subset of ${\bf X}_{ij}$ representing the "highly" significant GMAC confounders from \textbf{eq (1)} ($p<0.001$). Note that if the GMAC inferred mediation type was trans gene mediation only then the cis gene was simulated and the mediation test was preformed on the $\beta_1$ coefficient from $C_i = \beta_0 + \beta_1T_j + \beta_2L_i + {\bf \Gamma X}_{ij}+\epsilon$. 

We refer to the trans-gene generating function in \textbf{(2)} as the small truth model (STM) as the simulated trans gene comes from a model that is a subset of of the model described in \textbf{(1)}. Therefore, the simulated mediation test can be decomposed as the test on the $\beta_1$ coefficient from:

\begin{eqnarray} T_{j} = \beta_0+\beta_1C_i + \beta_2L_i + {\bf\Gamma}_1 {\bf W}_{ij} + {\bf \Gamma}_2{\bf M}_{ij} +\epsilon \end{eqnarray}

where ${\bf M}_{ij}$ represents the additional confounders in ${\bf X}_{ij}$ that are not included in ${\bf W}_{ij}$. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
cn=c("Adipose Subcutaneous","Artery Tibial","Muscle Skeletal","Skin Sun Exposed","Whole Blood")

rn=c("Min.", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max.")
dat=matrix(0, nrow=6, ncol = 5)
dat[,1]=c(0.000000, 0.000000, 0.000000, 0.006365, 0.003442, 0.156627)
dat[,2]=c(0.000000, 0.000000, 0.000000, 0.006625, 0.003425, 0.159247)
dat[,3]=c(0.000000, 0.000000, 0.000000, 0.006560, 0.002833, 0.158640)
dat[,4]=c(0.000000, 0.000000, 0.000000, 0.006701, 0.003306, 0.160331)
dat[,5]=c(0.000000, 0.000000, 0.000000, 0.006103, 0.002985, 0.155224)
colnames(dat)=cn
row.names(dat)=rn

kable(dat, caption = "Descriptive statistics for the distribution of missing values across the eQTL's for each tissue used in GMAC" )

```


\section*{3. Results}
\subsection*{3.1 Comparing GMAC and MRPC}


In light of the surprising number of trans-gene mediation trios inferred by MRPC, we sought to compare our results with GMAC by applying the GMAC method to the top five GTEx tissues by sample size. It is important to note that the test for mediation used by GMAC describes only the association between cis-gene and trans-gene transcripts ($C_i \leftrightarrow T_j$ ) and does not consider the possible effects between the cis-eQTL and the cis-gene ($L_i \rightarrow C_i$), or the cis-eQTL and trans-gene ($L_i \rightarrow T_j$). Therefore, since GMAC considers only the presence of the mediation edge, trios inferred to be one of M1, M2, or M4 under ADDIS, that were also significant under GMAC, were considered consistent (e.g $C_i \rightarrow T_j$; $T_j \rightarrow C_i$; $C_i \leftrightarrow T_j$ are synonymous under GMAC).

At the $10\%$ false discovery rate, GMAC identified $2,160$ trios with an edge between the cis and trans genes out of $55,446$ total trios tested across the five selected tissues: Adipose subcutaneous, Tibial artery, Muscle skeletal, Sun exposed skin, and Whole blood. Of the trios with mediation edges, 653 were identified as the cis gene mediating the trans gene, 245 as trans gene mediating the cis gene and 1,345 as both ($29.1\%, 10.9\%$, and $60\%$ respectively). As can be seen from \textbf{Table 2}, the consistency in inferred mediation edges between the two methods varied between $35\%$ and $46\%$ of the trios across tissues. 

To uncover the computational differences between MRPC and GMAC, we focused on trios with conflicting results between the two methods (trios inferred M0 or M3 under MRPC). The primary differences we observed between the two algorithms for these trios were that the inclusion of a larger set of confounding variables by GMAC often had the effect of strengthening the association between the cis and trans genes. That is, let ${\bf Z}_{ij}$ denote the set of confounding variables used under MRPC and ${\bf X}_{ij}$ the larger set used by GMAC such that the columns $\{z_{ij} \} \subset \{x_{ij}\}$. Because the confounding variables under GMAC are selected such that they have a significant association with both the cis and trans genes, the partial correlation between the cis gene and trans gene tends to strengthen as the column dimension of ${\bf Z}_{ij}$ approaches the column dimension of ${\bf X}_{ij}$. The result for GMAC is that under the mediation test, relatively weak associations ($0.1 \leq \rho \leq 0.2$) can be deemed significant. Conversely, for MRPC,  as the size of the network increases, the method becomes increasingly conservative. Therefore, when ${\bf Z}_{ij} = {\bf X}_{ij}$ MRPC tends to infer the null model unless the association between two nodes in the network is substantial.

\subsection*{3.2 Simulation Results}


```{r, echo=FALSE, message=FALSE, warning=FALSE}

table.final=read.csv("C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/summary.all.tissues.final.csv")

table.final[,9]=(table.final$M1+table.final$M2+table.final$M4)/table.final[,8]
colnames(table.final)=c("Tissue", paste0("M", c(0:4)), "Other", "Total GMAC Inferred", "Percentage In Common")

kable(table.final, caption = "The breakdown of unqiue trios with inferred significant cis or trans mediation under GMAC across their respective ADDIS inferred regulatory networks. The column \"Percentage In Common\" is the proportion of significant trios that also contained a mediation edge in the regulatory network inferred under ADDIS", digits = 4)
```










```{r, echo=FALSE, message=FALSE, warning=FALSE}

table.totals=read.csv("C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/final_result_table10000.csv")
table.unique=read.csv("C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/GMAC.unique.trios.breakdown.csv")
table3=cbind.data.frame(table.totals[,2:5], table.unique[,-1], rowSums(table.unique[,-1]))
colnames(table3)=c("Tissue", "Total Trios", "Total Cis Mediated", "Total Trans Mediated", "Unique Cis Only", "Unique Trans Only", "Unique Both", "Unique Total")
kable(table3, caption = "Breakdown of trios with inferred mediation under GMAC across both cis and trans mediation types. The column \"Unique Both\" represents the intersection of the columns \"Total Cis Mediated\" and \"Total Trans Mediated\" ")


```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ggpubr)

table.pcorM3=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/trios.pcors.summary.tableM3.txt", sep = "\t", header = T)

table.pcorM0=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/trios.pcors.summary.tableM0.txt", sep = "\t", header = T)

pcors=c(table.pcorM3$GMAC.pcor, table.pcorM3$ADDIS.pcor)
labels=c(rep('GMAC', length(table.pcorM3$GMAC.pcor)), rep("ADDIS", length(table.pcorM3$ADDIS.pcor)))

dat1=cbind.data.frame(pcors=pcors, labels=labels)

ggplot(data=dat1, aes(x=abs(pcors), fill=labels))+geom_density(alpha=0.5)+
  labs(title = "Density of Absolute Partial Correlations",
       x = expression(abs(rho)))



```

```{r, fig.cap="scatter plots for the number of PC's included by GMAC (top) and MRPC (bottom) and the percentage of total variation in expression the PC's summarize", echo=FALSE, message=FALSE, warning=FALSE}
sim=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/simulations.txt", sep="\t", header = T)

A=ggplot(data = sim, aes(x=Num.pcs.GMAC, y=Per.var.GMAC, color=Tissue))+
  geom_point()+
  ggtitle("%Var Accounted For by GMAC included PC's", subtitle = "GMAC")+
  xlab("Number of PC's")+
  ylab("%Total Variance In Expression")
B=ggplot(data = sim, aes(x=Num.pcs.MRPC, y=Per.var.MRPC, color=Tissue))+
  geom_point()+
  ggtitle("%Var Accounted For by GMAC included PC's", subtitle = "MRPC")+
  xlab("Number of PC's")+
  ylab("%Total Variance In Expression")

grid.arrange(A, B, nrow = 2)




```


```{r, fig.cap="Scatter plots of the mediation test p-values obtained from the permutation test (red) and the regression of the trans gene as described in eq (1) (black) across the simulated p-values using as described in Methods 2.3", echo=FALSE, message=FALSE, warning=FALSE}
sim=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/simulations.txt", sep="\t", header = T)

A=ggplot(data = sim)+
  geom_point(aes(x=perm.reg.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=Med.pvalue.GMAC, y=STM.med.p))+
  theme(legend.position = "none")+
  ggtitle("Scatter of Mediation P-values", subtitle = "Small True Model")+
  ylab("Mediation P-values from Simulation")+
  xlab("GMAC Mediation P-values")
B=ggplot(data = sim)+
  geom_point(aes(x=perm.reg.p, y=LTM.med.p, color="red"))+
  geom_point(aes(x=Med.pvalue.GMAC, y=LTM.med.p))+
  theme(legend.position = "none")+
  ggtitle("Scatter of Mediation P-values", subtitle = "Small True Model")+
  ylab("Mediation P-values from Simulation")+
  xlab("GMAC Mediation P-values")

grid.arrange(A, B, nrow = 2)




```


\newpage
\section*{References}