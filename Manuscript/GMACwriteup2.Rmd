---
title: "GMACwriteup2.RMD"
author: 
-  Jarred Kvamme, University of Idaho
date: "9/22/2021"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)
library(latex2exp)
library(gridExtra)
```




```{r, fig.cap="(A) scatter plots for the number of PC's included by GMAC and MRPC (B) and the percentage of total variation in expression summarized by the included PC's for each model", echo=FALSE, message=FALSE, warning=FALSE}
#sim=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/simulations_wholeblood.txt", sep="\t", header = T)
library(ggpubr)
library(prodlim)
sim=read.csv(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/TRIOS_imbalanced_genotypes_WB_m0m3.csv", header = T)


sim$alternative=(sim$het+2*sim$ha)/(2*rowSums(sim[,26:28]))
sim$reference=1-sim$alternative
genotypes=sim[,26:28]/rowSums(sim[,26:28])


#create color for allele frequencies of alternative or reference < 5% 
cv1=rep(0, dim(sim)[1])
cv2=replace(cv1, which(sim$alternative<=0.01 | sim$reference<=0.01), 1)
h=0.05
sim$colvar=as.factor(cv2)

A=ggplot(data = sim, aes(x=Num.pcs.GMAC, y=Per.var.GMAC, color=Tissue))+
  geom_point()+
  ggtitle("%Var Accounted For by GMAC included PC's", subtitle = "GMAC")+
  xlab("Number of PC's")+
  ylab("%Total Variance In Expression")
  #geom_abline(intercept = 0, slope = 0.5, linetype="dashed")
B=ggplot(data = sim, aes(x=Num.pcs.MRPC, y=Per.var.MRPC, color=Tissue))+
  geom_point()+
  ggtitle("%Var Accounted For by MRPC included PC's", subtitle = "MRPC")+
  xlab("Number of PC's")+
  ylab("%Total Variance In Expression")
  #geom_abline(intercept = 0, slope = 0.5, linetype="dashed")

ggarrange(A, B, nrow = 2, labels = c("A", "B"))




```




```{r, fig.cap="\\textbf{(A)} and \\textbf{(B)} the relationship between the observed $p$-value of the mediation test and the $p$-value from the simulated mediation test under the STM and LTM scenarios. \\textbf{(C)} and \\textbf{(D)} the relationship between the observed $p$-value of the permuted mediation test and the $p$-value from the simulated mediation tests under the STM and LTM scenarios. In all plots blue points represent trios with a rare allele observed at the SNP loci e.g having a frequency among subjects below $5\\%$. The dotted lines define the zone of insignificance at $\\log_{10}(\\alpha) = -1.301$ scale. Note that $p$-values < 2e-16 have been floored to $2e-16$", echo=FALSE, message=FALSE, warning=FALSE, results='hide',fig.keep='all'}
#sim=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/simulations.txt", sep="\t", header = T)

set.seed(222)

sim$adj.p1=sim$Med.pvalue.GMAC
sim$adj.p1[sim$adj.p1<=2e-16]=2e-16
sim$adj.p2=sim$STM.med.p
sim$adj.p2[sim$adj.p2<=2e-16]=2e-16

# cv2=sim$colvar
# sim$colvar2=as.factor(replace(cv2, sim$Med.pvalue.GMAC<2e-16, 2))

h=0.05
A=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p1), y=log10(adj.p2), color=colvar))+
  theme(legend.position = "none")+
 # ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Simulated Parametric P-value')),
       x = expression(log10('Observed Parametric P-value')),
       subtitle = "Small True Model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")
  #geom_text(aes( 0, h, label = 'log10(0.05)', hjust = 1.5, vjust=22), size = 3.5, color="red")

sim$adj.p3=sim$LTM.med.p
sim$adj.p3[sim$adj.p3<=2e-16]=2e-16

B=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=LTM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p1), y=log10(adj.p3), color=colvar))+
  theme(legend.position = "none")+
  #ggtitle("Scatter of Mediation Pvalues", subtitle = "Large True Model")+
  labs(y = expression(log10('Simulated Parametric P-value')),
       x = expression(log10('Observed Parametric P-value')),
       subtitle = "Large True Model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")

sim$adj.p4=sim$Perm.p.GMAC
sim$adj.p4[sim$adj.p4<=2e-16]=2e-16

sim$adj.p5=sim$STM.perm.p
sim$adj.p5[sim$adj.p5<=2e-16]=2e-16

A1=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p4), y=log10(adj.p5), color=colvar))+
  theme(legend.position = "none")+
  labs(y = expression(log10('Simulated Permutation P-value')),
       x = expression(log10('Observed Permutation P-value')),
       subtitle = "Small True Model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  #scale_x_continuous(limits = c(-100,0))+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")


sim$adj.p6=sim$LTM.perm.p
sim$adj.p6[sim$adj.p6<=2e-16]=2e-16

B1=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=LTM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p4), y=log10(adj.p6), color=colvar))+
  theme(legend.position = "none")+
  labs(y = expression(log10('Simulated Permutation P-value')),
       x = expression(log10('Observed Permutation P-value')),
       subtitle = "Large True Model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")


ggarrange(A, B, A1, B1, labels = c("A","B","C","D") , nrow=2, ncol=2)

```
















```{r, fig.cap="\\textbf{A and B} Comparison of the observed parametric and permuation $p$-values to those simulated under the True GMAC model scenario. \\textbf{C} comparison of the parametric to permuation $p$-values withing the TGM simulation. \\textbf{D} comparison of the parametric and permuation $p$-values within MRPC", echo=FALSE, message=FALSE, warning=FALSE,results='hide',fig.keep='all'}
#sim=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/simulations.txt", sep="\t", header = T)

set.seed(222)

sim$adj.p7=sim$TGM.p
sim$adj.p7[sim$adj.p7<=2e-16]=2e-16
sim$adj.p8=sim$Med.pvalue.MRPC
sim$adj.p8[sim$adj.p8<=2e-16]=2e-16
sim$adj.p9=sim$Perm.p.MRPC
sim$adj.p9[sim$adj.p9<=2e-16]=2e-16
sim$adj.p10=sim$TGM.perm
sim$adj.p10[sim$adj.p10<=2e-16]=2e-16

# cv2=sim$colvar
# sim$colvar2=as.factor(replace(cv2, sim$Med.pvalue.GMAC<2e-16, 2))

h=0.05
A=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p1), y=log10(adj.p7), color=colvar))+
  theme(legend.position = "none")+
 # ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Simulated TGM Parametric P-value')),
       x = expression(log10('Observed GMAC Parametric P-value')),
       subtitle = "True GMAC Model (TGM) for Trans Gene Analyzed with smaller MRPC model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")
  #geom_text(aes( 0, h, label = 'log10(0.05)', hjust = 1.5, vjust=22), size = 3.5, color="red")



B=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p4), y=log10(adj.p10), color=colvar))+
  theme(legend.position = "none")+
 # ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Simulated TGM Permutation P-value')),
       x = expression(log10('Observed GMAC Permutation P-value')),
       subtitle = "True GMAC Model (TGM) for Trans Gene Analyzed with smaller MRPC model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")
  #geom_text(aes( 0, h, label = 'log10(0.05)', hjust = 1.5, vjust=22), size = 3.5, color="red")


C=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p7), y=log10(adj.p10), color=colvar))+
  theme(legend.position = "none")+
 # ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Observed Permutation P-value')),
       x = expression(log10('Observed Parametric P-value')),
       subtitle = "True GMAC Model (TGM) for Trans Gene Analyzed with smaller MRPC model")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")
  #geom_text(aes( 0, h, label = 'log10(0.05)', hjust = 1.5, vjust=22), size = 3.5, color="red")

D=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_point(aes(x=log10(adj.p8), y=log10(adj.p9), color=colvar))+
  theme(legend.position = "none")+
 # ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Observed Permutation P-value')),
       x = expression(log10('Observed Parametric P-value')),
       subtitle = "MRPC")+
  scale_x_continuous(limits = c(-15,0))+
  scale_y_continuous(limits = c(-15,0))+
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")
  #geom_text(aes( 0, h, label = 'log10(0.05)', hjust = 1.5, vjust=22), size = 3.5, color="red")

ggarrange(A, B, C, D, labels = c("A","B","C","D") , nrow=2, ncol=2)

```








```{r, fig.cap="\\textbf{(A)} and \\textbf{(B)} The relationship between the simulated mediation $p$-value and the number of additional (STM scenario) or missing (LTM scenario) confounders in the analysis model relative to the true model generating the trans gene. In both plots blue boxes represent trios with a rare allele observed at the SNP loci e.g having a frequency among subjects below $5\\%$.", echo=FALSE, message=FALSE, warning=FALSE, results='hide',fig.keep='all'}
#sim=read.table(file="C:/Users/Bruin/Documents/GitHub/MRPC_support/GMAC analysis/master_tables/simulations.txt", sep="\t", header = T)

#set.seed(222)

# sim$adj.p1=sim$Med.pvalue.GMAC
# sim$adj.p1[sim$adj.p1<=2e-16]=2e-16+rnorm(length(which(sim$adj.p1<=2e-16)), 0, sd=sqrt(2e-16))
# sim$adj.p2=sim$STM.med.p
# sim$adj.p2[sim$adj.p2<=2e-16]=2e-16+rnorm(length(which(sim$adj.p2<=2e-16)), 0, sd=sqrt(2e-16))

TT=summary(as.factor(sim$STM.dim.diff))
rmv=as.numeric(names(TT[TT==1]))

sim.sub=sim[-c(match(rmv, sim$STM.dim.diff)),]

h=0.05
A=ggplot(data = sim.sub)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_boxplot(aes(x=as.factor(STM.dim.diff), y=log10(adj.p2), fill=colvar))+
  theme(legend.position = "none")+
  #ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Simulated Mediation P-value')),
       x = "Number of Additional Confounders In Analysis",
       subtitle = "Small True Model")+
  #scale_x_continuous(limits = c(0, 20))+
  #scale_y_continuous(limits = c(-15,0))+
  #geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  #geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")
  #geom_text(aes( 0, h, label = 'log10(0.05)', hjust = 1.5, vjust=22), size = 3.5, color="red")

# sim$adj.p3=sim$LTM.med.p
# sim$adj.p3[sim$adj.p3<=2e-16]=2e-16+rnorm(length(which(sim$adj.p3<=2e-16)), 0, sd=sqrt(2e-16))

# TT=summary(as.factor(sim$LTM.dim.diff))
# rmv=as.numeric(names(TT[TT==1]))
# 
# sim.sub=sim[-c(match(rmv, sim$LTM.dim.diff)),]

B=ggplot(data = sim)+
  #geom_point(aes(x=Perm.p, y=STM.med.p, color="red"))+
  geom_boxplot(aes(x=as.factor(LTM.dim.diff), y=log10(adj.p3), fill=colvar))+
  theme(legend.position = "none")+
  #ggtitle("Scatter of Mediation Pvalues", subtitle = "Small True Model")+
  labs(y = expression(log10('Simulated Mediation P-value')),
       x = "Number of Missing Confounders In Analysis",
       subtitle = "Large True Model")+
  #scale_x_continuous(limits = c(0, 20))+
  #scale_y_continuous(limits = c(-15,0))+
  #geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  #geom_vline(xintercept = log10(h), color="red", linetype="dashed")+
  geom_hline(yintercept = log10(h), color="red", linetype="dashed")




ggarrange(A, B, labels = c("A","B") , nrow=2)

```





























```{r, fig.cap="\\textbf{A} The distribution of the difference between the GMAC and MRPC models in terms of in percentage of variation captured by the PCs/confounders included by each model, and under the special case of trios for which the mediation test was significant under GMAC but insignificant under MRPC \\textbf{B} The distribution described for \\textbf{A} but under the alternative scenario when both GMAC and MRPC mediation tests were insignificant (not to be confused with the permutation test which is significant for GMAC). \\textbf{C} Comparison of the permutation and mediation $p$-values under GMAC. Blue points indicate trios with a corresponding rare allele at the SNP loci. \\textbf{D} Comparison of the permutation and mediation $p$-values under GMAC and excluding trios with a corresponding rare allele for visibility. In \\textbf{A,B,D} points along the black diagonal lines indicate near $1:1$ correspondence in the $p$-values between methods.", echo=FALSE, message=FALSE, warning=FALSE,results='hide',fig.keep='all'}




set.seed(222)


h=0.05

sim.sub1=subset(sim, Med.pvalue.GMAC<0.05 & Med.pvalue.MRPC>0.05)
sim.sub1$`Model Significance`=rep("GMAC p < 0.05 vs MRPC p > 0.05", dim(sim.sub1)[1])
sim.sub2=subset(sim, Med.pvalue.GMAC>0.05 & Med.pvalue.MRPC>0.05)
sim.sub2$`Model Significance`=rep("GMAC p > 0.05 vs MRPC p > 0.05", dim(sim.sub2)[1])

sim.sub=rbind.data.frame(sim.sub1, sim.sub2)
sim.sub$`Model Significance`=as.factor(sim.sub$`Model Significance`)

A=ggplot(data = sim.sub)+
  geom_boxplot(aes(x=`Model Significance`, y=Per.var.GMAC-Per.var.MRPC, fill=`Model Significance`))+
  theme(axis.text.x=element_blank())+
  #geom_histogram(aes(y = ..density..),color = "black", fill = "white")+
  #geom_density(alpha = 0.2, fill = "#FF6666") + theme_minimal()+
  labs(x = "Difference In % Variation Between GMAC and MRPC",
       col = expression('% Difference \nIn Variation \nIn Included \nPC\'s'))

mean1=mean(sim.sub1$Per.var.GMAC-sim.sub1$Per.var.MRPC)
mean2=mean(sim.sub2$Per.var.GMAC-sim.sub2$Per.var.MRPC)

B=ggplot(data = sim.sub)+geom_density(aes(x=Per.var.GMAC-Per.var.MRPC, fill=`Model Significance`), alpha=0.3, show.legend = FALSE)+
  geom_vline(xintercept = mean1, linetype="dotted")+
  geom_vline(xintercept = mean2, linetype="dotted")+
  #geom_histogram(aes(y = ..density..),color = "black", fill = "white")+
  #geom_density(alpha = 0.2) + 
  theme_minimal()+
  labs(x = "Difference In % Variation Between GMAC and MRPC",
       col = expression('% Difference \nIn Variation \nIn Included \nPC\'s'))


C=ggplot(data = sim)+
  geom_point(aes(x=Med.pvalue.GMAC, y=Med.pvalue.MRPC, color=colvar, label=Trio.Num))+
  #geom_point(aes(x=Med.pvalue.GMAC, y=STM.med.p))+
  theme(legend.position = "none")+
  #ggtitle("Scatter of Mediation Pvalues", )+
    labs(y = "Observed Permutation P-value (MRPC)",
       x = 'Observed Permutation P-value (GMAC)',
       subtitle = "Comparing Permutation Tests Under GMAC and MRPC")+
  geom_hline(yintercept = h, linetype="dashed", color="red")+
  geom_vline(xintercept = h, linetype="dashed", color="red")+
  scale_x_continuous(limits=c(0, 0.01))
  #geom_text(aes( -0.0004, h, label = h, vjust = -1), size = 5)+
  #scale_y_continuous(limits = c(0, 0.006))+
  geom_abline(slope = 1, intercept = 0, linetype="dashed")

  
D=ggplot(data = sim)+
  geom_point(aes(x=Perm.p.GMAC, y=Perm.p.MRPC, color=colvar, label=Trio.Num))+
  #geom_point(aes(x=Med.pvalue.GMAC, y=STM.med.p))+
  theme(legend.position = "none")+
  #ggtitle("Scatter of Mediation Pvalues", )+
    labs(y = "Observed Permutation P-value (MRPC)",
       x = 'Observed Permutation P-value (GMAC)',
       subtitle = "Comparing Permutation Tests Under GMAC and MRPC")+
  geom_hline(yintercept = h, linetype="dashed", color="red")+
  geom_text(aes( -0.0004, h, label = h, vjust = -1), size = 5)+
  scale_y_continuous(limits = c(0, h))+
  geom_abline(slope = 1, intercept = 0, linetype="dashed")



ggarrange(A,B,C,D, labels = c("A","B","C","D"), nrow=2, ncol=2)


```